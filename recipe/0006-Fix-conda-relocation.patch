From 99376c79dfa6ed055ee049a5ad2f7d6d02cf3f72 Mon Sep 17 00:00:00 2001
From: cxzhong <chenxin.zhong@outlook.com>
Date: Mon, 16 Feb 2026 14:20:23 +0800
Subject: [PATCH 1/2] Fix conda relocation

---
 src/global.cc | 36 ++++++++++++++++++++++++++++++++++--
 1 file changed, 34 insertions(+), 2 deletions(-)

diff --git a/src/global.cc b/src/global.cc
index 4afba32..8d9514b 100644
--- a/src/global.cc
+++ b/src/global.cc
@@ -174,6 +174,11 @@ int js_token(const char * list,const char * buf){
     return pos;
   }
 
+#if defined(__APPLE__)
+#define _DARWIN_C_SOURCE
+#endif
+#include <dlfcn.h>
+
 #ifdef HAVE_LIBMICROPYTHON
 std::string & python_console(){
   static std::string * ptr=0;
@@ -5039,7 +5044,20 @@ extern "C" void Sleep(unsigned int miliSecond);
       }
 #endif // GNUWINCE
 #else
-      s=giac_aide_location;
+      Dl_info info;
+      if (dladdr((void*)protected_read_config, &info)) {
+        char const * soname = info.dli_fname;
+        s = string(soname);
+        size_t last_slash = s.rfind('/');
+        s = s.substr(0, last_slash+1);
+        if (s.size() > 0) {
+          s += "../share/giac/aide_cas";
+        } else {
+          s=giac_aide_location;
+        }
+      } else {
+        s=giac_aide_location;
+      }
       s=s.substr(0,s.size()-8);
 #endif
       if (s.size()){
@@ -5095,7 +5113,21 @@ extern "C" void Sleep(unsigned int miliSecond);
       return ns;
     }
 #endif // WIN32
-    string s(giac_aide_location); // ".../aide_cas"
+    string s; // ".../aide_cas"
+    Dl_info info;
+    if (dladdr((void*)giac_aide_dir, &info)) {
+      char const * soname = info.dli_fname;
+      s = string(soname);
+      size_t last_slash = s.rfind('/');
+      s = s.substr(0, last_slash+1);
+      if (s.size() > 0) {
+        s += "../share/giac/aide_cas";
+      } else {
+        s=giac_aide_location;
+      }
+    } else {
+      s=giac_aide_location;
+    }
     // test if aide_cas is there, if not test at xcasroot() return ""
     if (!access(s.c_str(),R_OK)){
       s=s.substr(0,s.size()-8);
-- 
2.51.0

